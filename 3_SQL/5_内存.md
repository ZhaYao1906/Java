# 内存

# 0. 面试原题：MySQL中的InnoDB存储引擎，它的内存模型是什么样子的？

![屏幕截图 2025-03-10 223617.png](%E5%86%85%E5%AD%98%204130a0ee8b634b839913356096fbb519/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_2025-03-10_223617.png)

主要把**Buffer Pool和Change Buffer、Log Buffer三大组件**答出来就欧克了。

# 1. Buffer Pool

---

### 从MySQL获取数据，是从磁盘中读取的吗？

在MySQL中，获取数据并不总是直接从磁盘读取，MySQL使用缓存机制，会将常用的数据和索引缓存在内存中，以提高读取性能。当查询数据时，系统首先会检查缓存，如果数据存在于内存中，则直接从内存中读取，如果不在，则会从磁盘中读取并加载。

InnoDB存储引擎设计了一个**缓冲池（Buffer Pool）** 来 **提高数据库的读写性能。**

- 当读取数据时，如果数据存在于 Buffer Pool 中，客户端就会直接读取 Buffer Pool 中的数据，否则再去磁盘中读取。
- **修改数据时，** 修改数据和普通缓存不一样，要注意脏页的概念

修改数据时，如果数据存在于 Buffer Pool 中，那**直接修改 Buffer Pool 中数据所在的页，然后将其页设置为脏页（该页的内存数据和磁盘上的数据已经不一致），** 为了减少磁盘I/O，不会立即将脏页写入磁盘，后续**由后台线程选择选择一个合适的时机将脏页写入到磁盘。**

## Buffer Pool缓存什么？

InnoDB 会把存储的数据划分为若干个「页」，**以页作为磁盘和内存交互的基本单位，一个页的默认大小为 16KB。因此，Buffer Pool 同样需要按「页」来划分。**  

![image.png](%E5%86%85%E5%AD%98%204130a0ee8b634b839913356096fbb519/image.png)

undo页：开启事务后，InnoDB 层更新记录前，首先要记录相应的 undo log，如果是更新操作，需要把被更新的列的旧值记下来，也就是要生成一条undo log、undo log 会写入 Buffer Pool 中的 Undo 页面。

# 2.Change Buffer

是InnoDB存储引擎的一种优化机制，延迟写入二级索引的更新操作（`change buffer` 用于**临时存储对二级索引页的修改**，而不是立即将这些修改写入磁盘。）—> 这可以**减少I/O操作的频率，提高数据库的性能**。因为都是在内存中完成，而不是在磁盘中完成。

当一个事务对一个二级索引进行修改时，这些更改会首先被写入`change buffer`，然后在后台的合适时间再将这些更改应用到实际的索引页上。

### 适用场景

- Change Buffer 仅适用于**非唯一二级索引。**

二级索引：二级索引是**基于表中的其他字段（非主键字段）** 构建的索引。

- 对于唯一索引（如主键或唯一约束），InnoDB 必须立即检查唯一性，因此无法使用 Change Buffer。

### ChangeBuffer的作用

- 减少随机I/O

对二级索引的更新操作通常是随机写 I/O，性能较差。
Change Buffer 将这些随机写操作缓存到内存中，减少磁盘 I/O，提升性能。

- 提升写性能

在高并发写入场景下，Change Buffer 可以显著减少对磁盘的写操作，从而提升整体写入性能。

# 3.Log Buffer

MySQL中的Log Buffer是一个内存区域，用于暂时存储**事务日志（redo log）的数据。**

### Log Buffer的作用

Log Buffer 是一个内存区域，用于缓存重做日志记录，**避免每次事务提交时都直接写入磁盘。**

当日志记录达到一定条件时，InnoDB 会将 Log Buffer 中的内容刷新到磁盘上的重做日志文件中。

### Log Buffer的工作机制

- **事务提交**

当事务提交时，InnoDB 会将该事务的重做日志记录写入 Log Buffer。此时，**日志记录并未立即写入磁盘，而是暂存在 Log Buffer 中**。

- **日志刷新**

当日志记录达到一定条件时，InnoDB 会将 Log Buffer 中的内容刷新到磁盘上的重做日志文件中。

刷新条件包括：

1、Log Buffer 已满。

2、事务提交时设置了 innodb_flush_log_at_trx_commit=1。

3、后台线程定期刷新。

- **崩溃恢复**

如果数据库崩溃，InnoDB 会使用重做日志文件中的记录来恢复数据，确保数据的一致性。
